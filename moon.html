<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üåï Moon NFT Gallery</title>

<!-- Three.js for 3D rendering -->
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/PointerLockControls.js"></script>

<style>
  :root {
    --bg: #0a0a1a;
    --card-bg: #1e1e3a;
    --text-light: #e2e8f0;
    --accent: #3b82f6;
    --moon-surface: #6b7280;
  }
  
  * { 
    box-sizing: border-box; 
    margin: 0;
    padding: 0;
  }
  
  body { 
    font-family: system-ui, sans-serif; 
    background: var(--bg); 
    color: var(--text-light); 
    overflow: hidden;
    touch-action: none;
    width: 100vw;
    height: 100vh;
  }
  
  #canvas-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }
  
  .homepage{
    border-style: outset;
    width: 120px;
    height: 45px;
    background-image: url('https://i.pinimg.com/564x/35/38/ed/3538edbdb531c7fe3bb387ead4b398b0.jpg');
    background-size: 120px 45px;
    border-radius: 50%;
    text-align: center;
    line-height: 45px;
    color: white;
    font-weight: bold;
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 100;
    font-size: 0.8rem;
    pointer-events: auto;
  }
  
  header { 
    background: rgba(30, 30, 58, 0.8); 
    text-align: center; 
    padding: 12px 8px; 
    position: absolute; 
    top: 0; 
    width: 100%; 
    z-index: 10; 
    pointer-events: auto;
  }
  
  h1 { font-size: 1.4rem; margin: 0; }
  #location-info {
    margin-top: 6px;
    font-size: 0.8rem;
    color: #94a3b8;
  }
  
  #instructions {
    position: absolute;
    bottom: 10px;
    left: 0;
    width: 100%;
    text-align: center;
    color: white;
    background-color: rgba(0,0,0,0.7);
    padding: 8px;
    z-index: 100;
    font-size: 0.8rem;
    pointer-events: none;
  }
  
  #mobile-controls {
    position: absolute;
    bottom: 80px;
    right: 10px;
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: auto;
  }
  
  .mobile-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(59, 130, 246, 0.7);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    font-weight: bold;
    user-select: none;
    -webkit-user-select: none;
  }
  
  #look-controls {
    position: absolute;
    bottom: 80px;
    left: 10px;
    width: 120px;
    height: 120px;
    z-index: 100;
    background: rgba(0,0,0,0.2);
    border-radius: 50%;
    touch-action: none;
    pointer-events: auto;
  }
  
  #nft-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    padding: 20px;
    z-index: 1000;
    max-width: 90%;
    width: 350px;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  #nft-modal img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    display: block;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  
  #nft-modal h3 {
    margin: 8px 0 4px;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-light);
  }
  
  #nft-modal p {
    margin: 4px 0;
    font-size: 0.9rem;
    color: #94a3b8;
  }
  
  .nft-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
  }
  
  button {
    border: none;
    background: var(--accent);
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  button:hover {
    background: #2563eb;
  }
  
  #close-modal {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #ef4444;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  #close-modal:hover {
    background: #dc2626;
  }
  
  #mini-map {
    position: absolute;
    top: 70px;
    right: 10px;
    width: 120px;
    height: 120px;
    background: rgba(0,0,0,0.5);
    border-radius: 8px;
    z-index: 100;
    border: 2px solid #3b82f6;
  }
  
  #mini-map canvas {
    width: 100%;
    height: 100%;
    border-radius: 6px;
  }
  
  #earth-view {
    position: absolute;
    top: 70px;
    left: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 0.8rem;
    z-index: 100;
    max-width: 200px;
  }
  
  #spaceship-notification {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    z-index: 1000;
    display: none;
    border: 2px solid #3b82f6;
  }
  
  @media (max-width: 500px) { 
    header h1 { font-size: 1.2rem; } 
    #instructions {
      font-size: 0.7rem;
      bottom: 5px;
    }
    #mobile-controls {
      bottom: 60px;
    }
    #look-controls {
      bottom: 60px;
      width: 100px;
      height: 100px;
    }
    .mobile-btn {
      width: 45px;
      height: 45px;
      font-size: 1rem;
    }
    #mini-map {
      width: 100px;
      height: 100px;
      top: 60px;
    }
    #earth-view {
      top: 60px;
      font-size: 0.7rem;
      max-width: 150px;
    }
  }
</style>
</head>
<body>

<header>
  <h1>üåï Moon NFT Gallery</h1>
  <div id="location-info">Location: Moon Surface</div>
</header>

<a href='https://diamondrolls.github.io/thepremiumway/'> 
  <div class="homepage">Home</div>
</a>

<div id="canvas-container"></div>

<div id="instructions">
  <div id="desktop-instructions">Click to lock pointer and navigate with WASD keys. Find the return spaceship to go back to Earth!</div>
  <div id="mobile-instructions" style="display:none;">Use controls to move and look around. Find the return spaceship!</div>
</div>

<div id="earth-view">
  üåç Earth Visible in Sky
</div>

<div id="mobile-controls">
  <div class="mobile-btn" id="forward-btn">‚Üë</div>
  <div style="display:flex; gap:10px;">
    <div class="mobile-btn" id="left-btn">‚Üê</div>
    <div class="mobile-btn" id="backward-btn">‚Üì</div>
    <div class="mobile-btn" id="right-btn">‚Üí</div>
  </div>
  <div class="mobile-btn" id="jump-btn" style="background: rgba(34, 197, 94, 0.7);">‚§¥</div>
</div>

<div id="look-controls"></div>

<div id="mini-map"></div>

<div id="nft-modal">
  <button id="close-modal">X</button>
  <img id="modal-image" src="" alt="NFT" />
  <div class="nft-info">
    <h3 id="modal-title"></h3>
    <p id="modal-description"></p>
    <p><strong>Price:</strong> <span id="modal-price"></span> ETH</p>
    <div class="nft-actions" id="modal-actions"></div>
  </div>
</div>

<div id="spaceship-notification">
  <h3>üöÄ Return Spaceship Found!</h3>
  <p>Return to Earth NFT Marketplace?</p>
  <button id="confirm-return">Return to Earth</button>
  <button id="cancel-return" style="background: #6b7280; margin-top: 10px;">Stay on Moon</button>
</div>

<script>
/* ==============================
   MOBILE DETECTION & CONTROLS
============================== */
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
let lookTouchId = null;
let lookStartX = 0, lookStartY = 0;
let lookX = 0, lookY = 0;
let velocity = new THREE.Vector3();
let canJump = true;

if (isMobile) {
  document.getElementById('desktop-instructions').style.display = 'none';
  document.getElementById('mobile-instructions').style.display = 'block';
  
  // Set up mobile movement controls
  document.getElementById('forward-btn').addEventListener('touchstart', (e) => {
    e.preventDefault();
    moveForward = true;
  });
  document.getElementById('forward-btn').addEventListener('touchend', (e) => {
    e.preventDefault();
    moveForward = false;
  });
  
  document.getElementById('backward-btn').addEventListener('touchstart', (e) => {
    e.preventDefault();
    moveBackward = true;
  });
  document.getElementById('backward-btn').addEventListener('touchend', (e) => {
    e.preventDefault();
    moveBackward = false;
  });
  
  document.getElementById('left-btn').addEventListener('touchstart', (e) => {
    e.preventDefault();
    moveLeft = true;
  });
  document.getElementById('left-btn').addEventListener('touchend', (e) => {
    e.preventDefault();
    moveLeft = false;
  });
  
  document.getElementById('right-btn').addEventListener('touchstart', (e) => {
    e.preventDefault();
    moveRight = true;
  });
  document.getElementById('right-btn').addEventListener('touchend', (e) => {
    e.preventDefault();
    moveRight = false;
  });
  
  document.getElementById('jump-btn').addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (canJump) {
      velocity.y += 200; // Lower gravity on moon
      canJump = false;
    }
  });
  
  // Set up look controls
  const lookControls = document.getElementById('look-controls');
  lookControls.addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (lookTouchId === null) {
      const touch = e.touches[0];
      lookTouchId = touch.identifier;
      lookStartX = touch.clientX;
      lookStartY = touch.clientY;
    }
  });
  
  lookControls.addEventListener('touchmove', (e) => {
    e.preventDefault();
    for (let i = 0; i < e.changedTouches.length; i++) {
      const touch = e.changedTouches[i];
      if (touch.identifier === lookTouchId) {
        const deltaX = touch.clientX - lookStartX;
        const deltaY = touch.clientY - lookStartY;
        
        lookX = deltaX * 0.5;
        lookY = deltaY * 0.5;
        
        lookStartX = touch.clientX;
        lookStartY = touch.clientY;
        break;
      }
    }
  });
  
  lookControls.addEventListener('touchend', (e) => {
    e.preventDefault();
    for (let i = 0; i < e.changedTouches.length; i++) {
      const touch = e.changedTouches[i];
      if (touch.identifier === lookTouchId) {
        lookTouchId = null;
        lookX = 0;
        lookY = 0;
        break;
      }
    }
  });
}

/* ==============================
   3D SCENE SETUP
============================== */
let scene, camera, renderer, controls;
let nftObjects = [], environmentObjects = [], interactiveObjects = [];
let raycaster, mouse;
let currentIntersected = null;
let miniMapScene, miniMapCamera, miniMapRenderer;
let earth;
let clock = new THREE.Clock();
let prevTime = 0;
let returnSpaceship;
let moonRadius = 500;

function init3DScene() {
  // Create scene
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x000033); // Deep space blue
  scene.fog = new THREE.Fog(0x000033, 100, 2000);
  
  // Create camera
  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 3000);
  camera.position.set(0, 10, 50);
  
  // Create renderer
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.enabled = true;
  document.getElementById('canvas-container').appendChild(renderer.domElement);
  
  // Add lighting
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
  scene.add(ambientLight);
  
  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
  directionalLight.position.set(100, 100, 100);
  directionalLight.castShadow = true;
  directionalLight.shadow.mapSize.width = 2048;
  directionalLight.shadow.mapSize.height = 2048;
  scene.add(directionalLight);
  
  // Create the moon environment
  createMoonEnvironment();
  
  // Create Earth in the sky
  createEarth();
  
  // Create return spaceship
  createReturnSpaceship();
  
  // Set up controls
  if (!isMobile) {
    controls = new THREE.PointerLockControls(camera, document.body);
    
    document.addEventListener('click', function() {
      if (!controls.isLocked) {
        controls.lock();
      }
    });
    
    controls.addEventListener('lock', function() {
      document.getElementById('instructions').style.display = 'none';
    });
    
    controls.addEventListener('unlock', function() {
      document.getElementById('instructions').style.display = 'block';
    });
    
    // Keyboard controls for desktop
    const onKeyDown = function (event) {
      switch (event.code) {
        case 'ArrowUp':
        case 'KeyW':
          moveForward = true;
          break;
        case 'ArrowLeft':
        case 'KeyA':
          moveLeft = true;
          break;
        case 'ArrowDown':
        case 'KeyS':
          moveBackward = true;
          break;
        case 'ArrowRight':
        case 'KeyD':
          moveRight = true;
          break;
        case 'Space':
          if (canJump) {
            velocity.y += 200; // Lower gravity on moon
            canJump = false;
          }
          break;
      }
    };
    
    const onKeyUp = function (event) {
      switch (event.code) {
        case 'ArrowUp':
        case 'KeyW':
          moveForward = false;
          break;
        case 'ArrowLeft':
        case 'KeyA':
          moveLeft = false;
          break;
        case 'ArrowDown':
        case 'KeyS':
          moveBackward = false;
          break;
        case 'ArrowRight':
        case 'KeyD':
          moveRight = false;
          break;
      }
    };
    
    document.addEventListener('keydown', onKeyDown);
    document.addEventListener('keyup', onKeyUp);
  }
  
  // Set up raycaster for object interaction
  raycaster = new THREE.Raycaster();
  mouse = new THREE.Vector2();
  
  // Handle window resize
  window.addEventListener('resize', onWindowResize);
  
  // Initialize mini-map
  initMiniMap();
  
  // Start animation
  animate();
}

function createMoonEnvironment() {
  // Create moon surface (large sphere)
  const moonGeometry = new THREE.SphereGeometry(moonRadius, 64, 64);
  const moonMaterial = new THREE.MeshLambertMaterial({ 
    color: 0x6b7280,
    roughness: 0.9,
    metalness: 0.1
  });
  const moonSurface = new THREE.Mesh(moonGeometry, moonMaterial);
  moonSurface.receiveShadow = true;
  scene.add(moonSurface);
  
  // Add craters to the moon surface
  createCraters();
  
  // Add moon rocks and debris
  createMoonRocks();
}

function createCraters() {
  const craterGroup = new THREE.Group();
  
  for (let i = 0; i < 50; i++) {
    const craterSize = 10 + Math.random() * 40;
    const craterDepth = craterSize * 0.3;
    
    const craterGeometry = new THREE.SphereGeometry(craterSize, 16, 16, 0, Math.PI * 2, 0, Math.PI / 2);
    const craterMaterial = new THREE.MeshLambertMaterial({ 
      color: 0x4b5563,
      roughness: 0.95
    });
    
    const crater = new THREE.Mesh(craterGeometry, craterMaterial);
    
    // Position craters randomly on the moon's surface
    const phi = Math.acos(2 * Math.random() - 1);
    const theta = Math.random() * Math.PI * 2;
    const radius = moonRadius - craterDepth;
    
    crater.position.set(
      radius * Math.sin(phi) * Math.cos(theta),
      radius * Math.sin(phi) * Math.sin(theta),
      radius * Math.cos(phi)
    );
    
    // Rotate crater to face outward from moon center
    crater.lookAt(0, 0, 0);
    crater.rotateX(Math.PI); // Flip to create depression
    
    craterGroup.add(crater);
    environmentObjects.push(crater);
  }
  
  scene.add(craterGroup);
}

function createMoonRocks() {
  const rockGroup = new THREE.Group();
  
  for (let i = 0; i < 100; i++) {
    const rockSize = 2 + Math.random() * 8;
    const rockGeometry = new THREE.DodecahedronGeometry(rockSize, 0);
    const rockMaterial = new THREE.MeshLambertMaterial({ 
      color: 0x4b5563,
      roughness: 0.9
    });
    
    const rock = new THREE.Mesh(rockGeometry, rockMaterial);
    
    // Position rocks randomly on the moon's surface
    const phi = Math.acos(2 * Math.random() - 1);
    const theta = Math.random() * Math.PI * 2;
    const radius = moonRadius + rockSize * 0.5;
    
    rock.position.set(
      radius * Math.sin(phi) * Math.cos(theta),
      radius * Math.sin(phi) * Math.sin(theta),
      radius * Math.cos(phi)
    );
    
    // Random rotation
    rock.rotation.set(
      Math.random() * Math.PI,
      Math.random() * Math.PI,
      Math.random() * Math.PI
    );
    
    rock.castShadow = true;
    rockGroup.add(rock);
    environmentObjects.push(rock);
  }
  
  scene.add(rockGroup);
}

function createEarth() {
  // Create Earth sphere
  const earthGeometry = new THREE.SphereGeometry(150, 32, 32);
  const earthMaterial = new THREE.MeshLambertMaterial({ 
    color: 0x3b82f6,
    emissive: 0x1e40af,
    emissiveIntensity: 0.2
  });
  earth = new THREE.Mesh(earthGeometry, earthMaterial);
  
  // Position Earth in the sky
  earth.position.set(800, 600, -800);
  scene.add(earth);
  
  // Add cloud layer
  const cloudGeometry = new THREE.SphereGeometry(152, 32, 32);
  const cloudMaterial = new THREE.MeshLambertMaterial({
    color: 0xffffff,
    transparent: true,
    opacity: 0.3
  });
  const clouds = new THREE.Mesh(cloudGeometry, cloudMaterial);
  earth.add(clouds);
}

function createReturnSpaceship() {
  const spaceshipGroup = new THREE.Group();
  
  // Spaceship body (different design than Earth spaceship)
  const bodyGeometry = new THREE.CylinderGeometry(6, 8, 20, 8);
  const bodyMaterial = new THREE.MeshStandardMaterial({ 
    color: 0xdc2626,
    metalness: 0.8,
    roughness: 0.2
  });
  const spaceshipBody = new THREE.Mesh(bodyGeometry, bodyMaterial);
  spaceshipGroup.add(spaceshipBody);
  
  // Cockpit
  const cockpitGeometry = new THREE.SphereGeometry(4, 16, 16, 0, Math.PI * 2, 0, Math.PI / 2);
  const cockpitMaterial = new THREE.MeshStandardMaterial({ 
    color: 0x3b82f6,
    transparent: true,
    opacity: 0.7
  });
  const cockpit = new THREE.Mesh(cockpitGeometry, cockpitMaterial);
  cockpit.position.y = 6;
  cockpit.rotation.x = Math.PI;
  spaceshipGroup.add(cockpit);
  
  // Landing legs
  const legGeometry = new THREE.CylinderGeometry(0.8, 0.8, 10, 8);
  const legMaterial = new THREE.MeshStandardMaterial({ color: 0x374151 });
  
  for (let i = 0; i < 4; i++) {
    const angle = (i / 4) * Math.PI * 2;
    const leg = new THREE.Mesh(legGeometry, legMaterial);
    leg.position.set(
      Math.cos(angle) * 7,
      -10,
      Math.sin(angle) * 7
    );
    spaceshipGroup.add(leg);
  }
  
  // Engine glow (red for return ship)
  const engineGlowGeometry = new THREE.SphereGeometry(4, 16, 16);
  const engineGlowMaterial = new THREE.MeshBasicMaterial({
    color: 0xdc2626,
    transparent: true,
    opacity: 0.6
  });
  const engineGlow = new THREE.Mesh(engineGlowGeometry, engineGlowMaterial);
  engineGlow.position.y = -8;
  spaceshipGroup.add(engineGlow);
  
  // Position on moon surface
  const landingPosition = getMoonSurfacePosition(300, 0);
  spaceshipGroup.position.set(landingPosition.x, landingPosition.y, landingPosition.z);
  
  // Rotate to stand upright on moon surface
  spaceshipGroup.lookAt(0, 0, 0);
  spaceshipGroup.rotateX(-Math.PI / 2);
  
  spaceshipGroup.userData = {
    isSpaceship: true,
    type: 'return-to-earth',
    destination: 'https://diamondrolls.github.io/nft-marketplace/'
  };
  
  spaceshipGroup.castShadow = true;
  scene.add(spaceshipGroup);
  interactiveObjects.push(spaceshipGroup);
  
  returnSpaceship = spaceshipGroup;
  
  // Add pulsing animation to engine glow
  function pulseEngine() {
    if (engineGlow) {
      engineGlow.scale.x = 1 + Math.sin(Date.now() * 0.005) * 0.3;
      engineGlow.scale.y = 1 + Math.sin(Date.now() * 0.005) * 0.3;
      engineGlow.scale.z = 1 + Math.sin(Date.now() * 0.005) * 0.3;
    }
    requestAnimationFrame(pulseEngine);
  }
  pulseEngine();
}

function getMoonSurfacePosition(distance, angle) {
  // Convert polar coordinates to 3D position on moon surface
  const x = Math.cos(angle) * distance;
  const z = Math.sin(angle) * distance;
  const y = Math.sqrt(Math.max(0, moonRadius * moonRadius - x * x - z * z));
  return new THREE.Vector3(x, y, z);
}

function initMiniMap() {
  miniMapScene = new THREE.Scene();
  miniMapCamera = new THREE.OrthographicCamera(-moonRadius, moonRadius, moonRadius, -moonRadius, 0.1, 2000);
  miniMapCamera.position.y = moonRadius * 2;
  miniMapCamera.lookAt(0, 0, 0);
  
  const miniMapCanvas = document.createElement('canvas');
  miniMapCanvas.width = 120;
  miniMapCanvas.height = 120;
  document.getElementById('mini-map').appendChild(miniMapCanvas);
  
  miniMapRenderer = new THREE.WebGLRenderer({ 
    canvas: miniMapCanvas,
    antialias: false 
  });
  miniMapRenderer.setSize(120, 120);
  miniMapRenderer.setClearColor(0x000000, 0.5);
  
  // Add moon surface to mini-map
  const moonGeometry = new THREE.CircleGeometry(moonRadius, 32);
  const moonMaterial = new THREE.MeshBasicMaterial({ color: 0x6b7280 });
  const moonSurface = new THREE.Mesh(moonGeometry, moonMaterial);
  moonSurface.rotation.x = -Math.PI / 2;
  miniMapScene.add(moonSurface);
  
  // Add player indicator
  const playerGeometry = new THREE.CircleGeometry(15, 8);
  const playerMaterial = new THREE.MeshBasicMaterial({ color: 0xFF0000 });
  const playerIndicator = new THREE.Mesh(playerGeometry, playerMaterial);
  playerIndicator.rotation.x = -Math.PI / 2;
  miniMapScene.add(playerIndicator);
  
  // Add spaceship indicator
  const spaceshipGeometry = new THREE.CircleGeometry(12, 6);
  const spaceshipMaterial = new THREE.MeshBasicMaterial({ color: 0xDC2626 });
  const spaceshipIndicator = new THREE.Mesh(spaceshipGeometry, spaceshipMaterial);
  spaceshipIndicator.rotation.x = -Math.PI / 2;
  spaceshipIndicator.userData = { isSpaceshipIndicator: true };
  miniMapScene.add(spaceshipIndicator);
  
  // Add NFT indicators
  const nftIndicatorGeometry = new THREE.CircleGeometry(8, 6);
  const nftIndicatorMaterial = new THREE.MeshBasicMaterial({ color: 0xF59E0B });
  
  window.updateMiniMap = function() {
    // Update player position
    playerIndicator.position.x = camera.position.x;
    playerIndicator.position.z = camera.position.z;
    
    // Update spaceship position
    spaceshipIndicator.position.x = returnSpaceship.position.x;
    spaceshipIndicator.position.z = returnSpaceship.position.z;
    
    // Update location info
    updateLocationInfo();
    
    // Clear previous NFT indicators
    miniMapScene.children.forEach((child, index) => {
      if (child.userData && child.userData.isNFTIndicator) {
        miniMapScene.children.splice(index, 1);
      }
    });
    
    // Add current NFT indicators
    nftObjects.forEach(nft => {
      const indicator = new THREE.Mesh(nftIndicatorGeometry, nftIndicatorMaterial);
      indicator.position.x = nft.position.x;
      indicator.position.z = nft.position.z;
      indicator.rotation.x = -Math.PI / 2;
      indicator.userData = { isNFTIndicator: true };
      miniMapScene.add(indicator);
    });
    
    miniMapRenderer.render(miniMapScene, miniMapCamera);
  };
}

function updateLocationInfo() {
  const locationInfo = document.getElementById('location-info');
  const x = camera.position.x;
  const z = camera.position.z;
  
  // Check if player is near the return spaceship
  const distanceToSpaceship = Math.sqrt(
    Math.pow(x - returnSpaceship.position.x, 2) + 
    Math.pow(z - returnSpaceship.position.z, 2)
  );
  
  if (distanceToSpaceship < 40) {
    locationInfo.textContent = "Location: Return Spaceship Site";
    locationInfo.style.color = "#dc2626";
  } else {
    locationInfo.textContent = "Location: Moon Surface";
    locationInfo.style.color = "#94a3b8";
  }
}

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
  requestAnimationFrame(animate);
  
  const time = performance.now();
  const delta = (time - prevTime) / 1000;
  
  // Handle movement (lower gravity on moon)
  if (controls && controls.isLocked) {
    const moveSpeed = 150.0 * delta; // Slower movement on moon
    
    if (moveForward) {
      velocity.z = -moveSpeed;
    }
    if (moveBackward) {
      velocity.z = moveSpeed;
    }
    if (moveLeft) {
      velocity.x = -moveSpeed;
    }
    if (moveRight) {
      velocity.x = moveSpeed;
    }
    
    // Apply lower gravity (moon gravity)
    velocity.y -= 1.62 * 100.0 * delta; // Moon gravity is 1.62 m/s¬≤
    
    // Move the camera
    controls.moveRight(-velocity.x * delta);
    controls.moveForward(-velocity.z * delta);
    
    // Update camera Y position based on velocity
    camera.position.y += (velocity.y * delta);
    
    // Keep player on moon surface (simplified)
    const distanceFromCenter = Math.sqrt(camera.position.x**2 + camera.position.y**2 + camera.position.z**2);
    if (distanceFromCenter < moonRadius + 2) {
      camera.position.y = Math.sqrt(Math.max(0, moonRadius**2 - camera.position.x**2 - camera.position.z**2)) + 2;
      velocity.y = 0;
      canJump = true;
    }
    
    // Reset velocity for next frame
    velocity.x = 0;
    velocity.z = 0;
  }
  
  // Handle movement for mobile
  if (isMobile) {
    const moveSpeed = 80.0 * delta; // Slower movement on moon
    
    if (moveForward) {
      camera.translateZ(-moveSpeed);
    }
    if (moveBackward) {
      camera.translateZ(moveSpeed);
    }
    if (moveLeft) {
      camera.translateX(-moveSpeed);
    }
    if (moveRight) {
      camera.translateX(moveSpeed);
    }
    
    // Apply lower gravity for mobile
    velocity.y -= 1.62 * 100.0 * delta;
    camera.position.y += (velocity.y * delta);
    
    // Keep player on moon surface (simplified)
    const distanceFromCenter = Math.sqrt(camera.position.x**2 + camera.position.y**2 + camera.position.z**2);
    if (distanceFromCenter < moonRadius + 2) {
      camera.position.y = Math.sqrt(Math.max(0, moonRadius**2 - camera.position.x**2 - camera.position.z**2)) + 2;
      velocity.y = 0;
      canJump = true;
    }
    
    // Handle look for mobile
    if (lookX !== 0 || lookY !== 0) {
      camera.rotation.y -= lookX * 0.01;
      camera.rotation.x -= lookY * 0.01;
      camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
    }
  }
  
  // Update raycaster for object interaction
  if (!isMobile && controls && controls.isLocked) {
    raycaster.setFromCamera(mouse, camera);
  } else {
    // For mobile, we'll use a fixed direction (forward)
    raycaster.set(camera.position, camera.getWorldDirection(new THREE.Vector3()));
  }
  
  const intersects = raycaster.intersectObjects([...nftObjects, ...interactiveObjects]);
  
  if (intersects.length > 0) {
    if (currentIntersected !== intersects[0].object) {
      // Reset previous intersection
      if (currentIntersected) {
        if (currentIntersected.userData.originalEmissive !== undefined) {
          currentIntersected.material.emissive.setHex(currentIntersected.userData.originalEmissive);
        }
      }
      
      // Set new intersection
      currentIntersected = intersects[0].object;
      
      if (currentIntersected.userData.isSpaceship) {
        // Highlight spaceship with different color
        currentIntersected.userData.originalEmissive = 0x000000;
        currentIntersected.children.forEach(child => {
          if (child.material && child.material.emissive) {
            child.material.emissive.setHex(0x00ff00);
          }
        });
      } else if (currentIntersected.userData.originalEmissive !== undefined) {
        currentIntersected.userData.originalEmissive = currentIntersected.material.emissive.getHex();
        currentIntersected.material.emissive.setHex(0xF59E0B); // Gold color for moon NFTs
      }
      
      // Change cursor to pointer
      if (!isMobile) {
        document.body.style.cursor = 'pointer';
      }
    }
  } else {
    if (currentIntersected) {
      if (currentIntersected.userData.isSpaceship) {
        // Reset spaceship highlight
        currentIntersected.children.forEach(child => {
          if (child.material && child.material.emissive) {
            child.material.emissive.setHex(0x000000);
          }
        });
      } else if (currentIntersected.userData.originalEmissive !== undefined) {
        currentIntersected.material.emissive.setHex(currentIntersected.userData.originalEmissive);
      }
      currentIntersected = null;
      if (!isMobile) {
        document.body.style.cursor = 'auto';
      }
    }
  }
  
  // Update mini-map
  if (window.updateMiniMap) {
    window.updateMiniMap();
  }
  
  // Rotate Earth slowly
  if (earth) {
    earth.rotation.y += 0.001;
  }
  
  prevTime = time;
  renderer.render(scene, camera);
}

function createNFTPlane(nftData, position) {
  // Create a plane for the NFT image
  const geometry = new THREE.PlaneGeometry(8, 8);
  
  // Create texture loader
  const textureLoader = new THREE.TextureLoader();
  const texture = textureLoader.load(nftData.image_url, function() {
    // Texture loaded
  });
  
  const material = new THREE.MeshStandardMaterial({ 
    map: texture,
    side: THREE.DoubleSide,
    transparent: true,
    opacity: 0.9
  });
  
  const plane = new THREE.Mesh(geometry, material);
  plane.position.set(position.x, position.y, position.z);
  
  // Rotate to face outward from moon center
  plane.lookAt(0, 0, 0);
  
  // Store NFT data for interaction
  plane.userData.nftData = nftData;
  plane.userData.originalEmissive = 0x000000;
  
  scene.add(plane);
  nftObjects.push(plane);
  
  // Add a subtle glow effect (gold for moon NFTs)
  const glowGeometry = new THREE.PlaneGeometry(8.5, 8.5);
  const glowMaterial = new THREE.MeshBasicMaterial({ 
    color: 0xF59E0B, // Gold color for moon
    transparent: true,
    opacity: 0.4,
    side: THREE.DoubleSide
  });
  const glow = new THREE.Mesh(glowGeometry, glowMaterial);
  glow.position.copy(plane.position);
  glow.rotation.copy(plane.rotation);
  scene.add(glow);
  
  // Make glow part of the NFT object for interaction
  plane.userData.glow = glow;
}

function openNFTModal(nftData) {
  document.getElementById('modal-image').src = nftData.image_url;
  document.getElementById('modal-title').textContent = `${nftData.collection || 'Untitled'} #${nftData.token_id ?? ''}`;
  document.getElementById('modal-description').textContent = nftData.description || 'No description available';
  document.getElementById('modal-price').textContent = nftData.price_eth ?? 'N/A';
  
  let buttons = "";
  buttons = `<p>üåï Special Moon NFT</p><p>Connect wallet on Earth to trade</p>`;
  
  document.getElementById('modal-actions').innerHTML = buttons;
  document.getElementById('nft-modal').style.display = 'block';
}

document.getElementById('close-modal').addEventListener('click', function() {
  document.getElementById('nft-modal').style.display = 'none';
});

// Spaceship return functionality
document.getElementById('confirm-return').addEventListener('click', function() {
  window.location.href = 'https://diamondrolls.github.io/nft-marketplace/';
});

document.getElementById('cancel-return').addEventListener('click', function() {
  document.getElementById('spaceship-notification').style.display = 'none';
});

// Handle click/tap on objects
document.addEventListener('click', function onClick(event) {
  if (((!isMobile && controls && controls.isLocked) || (isMobile && currentIntersected)) && currentIntersected) {
    if (currentIntersected.userData.isSpaceship) {
      // Show spaceship return notification
      document.getElementById('spaceship-notification').style.display = 'block';
    } else {
      const nftData = currentIntersected.userData.nftData;
      openNFTModal(nftData);
    }
  }
});

/* ==============================
   LOAD NFTs FOR MOON
============================== */
async function loadMoonNFTs() {
  // For demo purposes, create some placeholder NFT data
  // In a real implementation, you would fetch from your database
  const moonNFTs = [
    {
      token_id: 1001,
      collection: "Lunar Collection",
      description: "Exclusive Moon Edition NFT",
      image_url: "https://raw.githubusercontent.com/diamondrolls/images/main/moon-nft-1.jpg",
      price_eth: "0.5"
    },
    {
      token_id: 1002,
      collection: "Cosmic Arts",
      description: "Art created in zero gravity",
      image_url: "https://raw.githubusercontent.com/diamondrolls/images/main/moon-nft-2.jpg",
      price_eth: "0.8"
    },
    {
      token_id: 1003,
      collection: "Space Explorers",
      description: "Commemorative moon landing NFT",
      image_url: "https://raw.githubusercontent.com/diamondrolls/images/main/moon-nft-3.jpg",
      price_eth: "1.2"
    },
    {
      token_id: 1004,
      collection: "Lunar Collection",
      description: "Rare moon surface artwork",
      image_url: "https://raw.githubusercontent.com/diamondrolls/images/main/moon-nft-4.jpg",
      price_eth: "0.7"
    },
    {
      token_id: 1005,
      collection: "Cosmic Arts",
      description: "Digital art inspired by the cosmos",
      image_url: "https://raw.githubusercontent.com/diamondrolls/images/main/moon-nft-5.jpg",
      price_eth: "0.9"
    }
  ];

  // Clear existing NFTs
  nftObjects.forEach(obj => {
    scene.remove(obj);
    if (obj.userData.glow) {
      scene.remove(obj.userData.glow);
    }
  });
  nftObjects = [];
  
  // Position NFTs randomly on the moon surface
  moonNFTs.forEach((nft, index) => {
    // Position NFTs in a wide arc around the landing site
    const angle = (index / moonNFTs.length) * Math.PI * 1.5 + Math.PI/4;
    const distance = 80 + Math.random() * 120;
    
    const position = getMoonSurfacePosition(distance, angle);
    
    // Raise slightly above surface
    position.normalize().multiplyScalar(moonRadius + 5);
    
    createNFTPlane(nft, position);
  });
}

// Initialize the 3D scene
init3DScene();
loadMoonNFTs();
</script>

</body>
</html>
