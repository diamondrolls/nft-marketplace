<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NFT Marketplace</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.min.js"></script>
</head>
<body>
  <h1>NFT Marketplace</h1>

  <button onclick="connectWallet()">ðŸ”— Connect Wallet</button>
  <div id="wallet-address"></div>

  <div>
    <h2>My NFTs</h2>
    <ul id="my-nfts-list"></ul>
  </div>

  <div id="nft-list"></div>

  <script>
    // ---- Supabase Setup ----
    const supabaseUrl = "https://fjtzodjudyctqacunlqp.supabase.co";
    const supabaseKey = "your-supabase-key";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // ---- Wallet Setup ----
    let provider, signer, userAddress;
    const platformWallet = "0xaE0C180e071eE288B2F2f6ff6edaeF014678fFB7"; // where you collect fees/payments

    async function connectWallet() {
      if (window.ethereum) {
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        document.getElementById("wallet-address").innerText = "Connected: " + userAddress;
        loadNFTs();
      } else {
        alert("Please install MetaMask!");
      }
    }

    // ---- Load NFTs ----
    async function loadNFTs() {
      const { data: nfts, error } = await supabase.from("nfts").select("*");
      if (error) {
        console.error(error);
        return;
      }

      const container = document.getElementById("nft-list");
      container.innerHTML = "";

      const myNFTsList = document.getElementById("my-nfts-list");
      myNFTsList.innerHTML = "";

      for (const nft of nfts) {
        let html = `
          <div style="border:1px solid #ddd; margin:10px; padding:10px; width:250px;">
            <img src="${nft.image_url}" width="200"><br>
            <b>${nft.name}</b><br>
            $${nft.price}<br>
        `;

        if (nft.buyer_wallet?.toLowerCase() === userAddress?.toLowerCase()) {
          html += `
            <div>
              <input id="transfer-${nft.id}" placeholder="Recipient wallet" style="width:90%; margin-top:6px;">
              <button onclick="transferNFT(${nft.id})">Transfer ($6 fee)</button>
            </div>
          `;
          myNFTsList.innerHTML += `<li>${nft.name}</li>`;
        } else if (!nft.sold) {
          html += `<button onclick="buyNFT(${nft.id}, ${nft.price})">Buy with MetaMask</button>`;
        } else {
          html += `<p style="color:gray;">Sold</p>`;
        }

        html += "</div>";
        container.innerHTML += html;
      }
    }

    // ---- Buy NFT ----
    async function buyNFT(nftId, priceUSD) {
      if (!signer) {
        alert("Connect your wallet first!");
        return;
      }

      // Add $6 platform fee
      const totalUSD = priceUSD + 6;
      const ethPrice = totalUSD * 0.00032; // rough USDâ†’ETH estimate
      const ethAmount = ethers.parseEther(ethPrice.toFixed(6).toString());

      try {
        // Send crypto payment
        const tx = await signer.sendTransaction({
          to: platformWallet,
          value: ethAmount
        });

        await tx.wait();

        // Update Supabase NFT
        const { error } = await supabase
          .from("nfts")
          .update({
            sold: true,
            buyer_wallet: userAddress
          })
          .eq("id", nftId);

        if (error) throw error;

        alert(`âœ… NFT purchased! Tx: ${tx.hash}`);
        loadNFTs();
      } catch (err) {
        console.error(err);
        alert("Transaction failed: " + err.message);
      }
    }

    // ---- Transfer NFT ----
    async function transferNFT(nftId) {
      if (!signer) {
        alert("Connect your wallet first!");
        return;
      }

      const input = document.getElementById(`transfer-${nftId}`);
      const newOwner = input.value.trim();

      if (!ethers.isAddress(newOwner)) {
        alert("Invalid wallet address");
        return;
      }

      try {
        const feeUSD = 6;
        const ethFee = feeUSD * 0.00032;
        const ethAmount = ethers.parseEther(ethFee.toFixed(6).toString());

        const tx = await signer.sendTransaction({
          to: platformWallet,
          value: ethAmount
        });

        await tx.wait();

        const { error } = await supabase
          .from("nfts")
          .update({
            buyer_wallet: newOwner
          })
          .eq("id", nftId);

        if (error) throw error;

        alert(`âœ… NFT transferred to ${newOwner}. Tx: ${tx.hash}`);
        loadNFTs();
      } catch (err) {
        console.error(err);
        alert("Transfer failed: " + err.message);
      }
    }

    // Load NFTs immediately
    loadNFTs();
  </script>
</body>
</html>
