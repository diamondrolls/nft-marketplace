<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NFT Marketplace</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.min.js"></script>
</head>
<body>
  <h1>NFT Marketplace</h1>

  <button onclick="connectWallet()">ðŸ”— Connect Wallet</button>
  <div id="wallet-address"></div>

  <div id="nft-list"></div>

  <script>
    // ---- Supabase Setup ----
    const supabaseUrl = "https://fjtzodjudyctqacunlqp.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqdHpvZGp1ZHljdHFhY3VubHFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNjA2OTQsImV4cCI6MjA3MzYzNjY5NH0.qR9RBsecfGUfKnbWgscmxloM-oEClJs_bo5YWoxFoE4";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Redirect to login page if not logged in
  supabase.auth.getSession().then(({ data }) => {
  if (!data.session) {
    window.location.href = 'https://diamondrolls.github.io/play/';
  }
});

    // ---- Wallet Setup ----
    let provider, signer, userAddress;
    const platformWallet = "0xaE0C180e071eE288B2F2f6ff6edaeF014678fFB7"; // where you collect fees/payments

    async function connectWallet() {
      if (window.ethereum) {
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        document.getElementById("wallet-address").innerText = "Connected: " + userAddress;
      } else {
        alert("Please install MetaMask!");
      }
    }

    // ---- Load NFTs from Supabase ----
    async function loadNFTs() {
      const { data: nfts, error } = await supabase.from("nfts").select("*").eq("sold", false);
      if (error) {
        console.log(error);
        return;
      }
      const container = document.getElementById("nft-list");
      container.innerHTML = nfts.map(nft => `
        <div style="border:1px solid #ddd; margin:10px; padding:10px; width:250px;">
          <img src="${nft.image_url}" width="200"><br>
          <b>${nft.name}</b><br>
          $${nft.price}<br>
          <button onclick="buyNFT(${nft.id}, ${nft.price})">Buy with MetaMask</button>
        </div>
      `).join("");
    }

    // ---- Buy NFT ----
    async function buyNFT(nftId, priceUSD) {
      if (!signer) {
        alert("Connect your wallet first!");
        return;
      }

      // Add $6 platform fee
      const totalUSD = priceUSD + 6;

      // For demo: $1 â‰ˆ 0.00032 ETH  â†’ adjust or use live price API later
      const ethPrice = totalUSD * 0.00032;
      const ethAmount = ethers.parseEther(ethPrice.toFixed(6).toString());

      try {
        // Send crypto payment
        const tx = await signer.sendTransaction({
          to: platformWallet,
          value: ethAmount
        });

        await tx.wait();

        // Mark NFT as sold in Supabase
        const { error } = await supabase
          .from("nfts")
          .update({
            sold: true,
            buyer_wallet: userAddress
          })
          .eq("id", nftId);

        if (error) throw error;

        alert(`âœ… NFT purchased! Transaction: ${tx.hash}`);
        loadNFTs(); // refresh list
      } catch (err) {
        console.error(err);
        alert("Transaction failed: " + err.message);
      }
    }

    loadNFTs();
  </script>
</body>
</html>

